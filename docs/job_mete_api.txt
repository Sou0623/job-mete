# ğŸ”Œ Job Mete APIè¨­è¨ˆæ›¸ v1.5

---

## 1. APIæ¦‚è¦

### 1.1 APIã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**æ–¹å¼:** Firebase Cloud Functions (HTTPS Callable)

**ç‰¹å¾´:**
- âœ… è‡ªå‹•çš„ãªèªè¨¼ãƒã‚§ãƒƒã‚¯ï¼ˆcontext.authï¼‰
- âœ… å‹å®‰å…¨ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- âœ… ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆSDKã¨ã®çµ±åˆ
- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ¨™æº–åŒ–
- âœ… ãƒªãƒˆãƒ©ã‚¤ãƒ¡ã‚«ãƒ‹ã‚ºãƒ 

**Base URLï¼ˆãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼‰:**
```
http://localhost:5001/{project-id}/{region}/
```

**Base URLï¼ˆæœ¬ç•ªç’°å¢ƒãƒ»å°†æ¥ï¼‰:**
```
https://{region}-{project-id}.cloudfunctions.net/
```

---

## 2. èªè¨¼ã¨èªå¯

### 2.1 èªè¨¼æ–¹å¼

**æ¡ç”¨:** Firebase Authentication ID Token

**ãƒ•ãƒ­ãƒ¼:**
```
[ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ]
    â†“ Firebase SDK
[Firebase Auth] â†’ ID Tokenç”Ÿæˆ
    â†“
[HTTPS Callable Function]
    â†“ context.authè‡ªå‹•æ¤œè¨¼
[é–¢æ•°å®Ÿè¡Œ]
```

### 2.2 èªå¯ãƒã‚§ãƒƒã‚¯

```typescript
// å…¨ã¦ã®Functionã§å®Ÿè¡Œ
if (!context.auth) {
  throw new functions.https.HttpsError(
    'unauthenticated',
    'ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™'
  );
}

const userId = context.auth.uid;
```

---

## 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 3.1 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ä¸€è¦§

| ã‚³ãƒ¼ãƒ‰ | æ„å‘³ | HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ä½¿ç”¨ä¾‹ |
|-------|------|--------------|--------|
| `unauthenticated` | èªè¨¼ã‚¨ãƒ©ãƒ¼ | 401 | ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ |
| `permission-denied` | æ¨©é™ã‚¨ãƒ©ãƒ¼ | 403 | ä»–äººã®ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ |
| `not-found` | ãƒªã‚½ãƒ¼ã‚¹ä¸åœ¨ | 404 | ä¼æ¥­IDãŒå­˜åœ¨ã—ãªã„ |
| `already-exists` | é‡è¤‡ã‚¨ãƒ©ãƒ¼ | 409 | ä¼æ¥­ãŒæ—¢ã«ç™»éŒ²æ¸ˆã¿ |
| `invalid-argument` | å¼•æ•°ã‚¨ãƒ©ãƒ¼ | 400 | å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³ |
| `resource-exhausted` | ãƒ¬ãƒ¼ãƒˆåˆ¶é™ | 429 | APIä¸Šé™åˆ°é” |
| `internal` | ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ | 500 | äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ |

### 3.2 ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼

```typescript
{
  code: string;           // ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
  message: string;        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæ—¥æœ¬èªï¼‰
  details?: any;          // è¿½åŠ æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
}
```

**ä¾‹:**
```json
{
  "code": "already-exists",
  "message": "ã“ã®ä¼æ¥­ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™",
  "details": {
    "existingCompanyId": "company_abc123",
    "normalizedName": "ã“ã©ã‚‚ã‚“"
  }
}
```

---

## 4. APIä»•æ§˜

### 4.1 ä¼æ¥­ç®¡ç†API

---

#### ğŸ“Œ POST /createCompany

**èª¬æ˜:** ä¼æ¥­ã‚’æ–°è¦ç™»éŒ²ã—ã€Gemini APIã§ä¼æ¥­åˆ†æã‚’å®Ÿè¡Œ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  companyName: string;      // å¿…é ˆ: ä¼æ¥­å
  forceCreate?: boolean;    // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: é‡è¤‡æ™‚ã‚‚å¼·åˆ¶ä½œæˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: falseï¼‰
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸæ™‚ï¼‰:**
```typescript
{
  success: true;
  isDuplicate: false;
  companyId: string;        // ä½œæˆã•ã‚ŒãŸä¼æ¥­ID
  analysis: {               // Geminiåˆ†æçµæœ
    businessOverview: string;
    strengths: string[];
    recentNews: string;
    industryPosition: string;
    recruitmentInsights: string;
  };
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆé‡è¤‡æ¤œå‡ºæ™‚ï¼‰:**
```typescript
{
  success: false;
  isDuplicate: true;
  existingCompany: {
    id: string;
    companyName: string;
    normalizedName: string;
    createdAt: string;
    stats: {
      eventCount: number;
    };
  };
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `invalid-argument`: companyNameãŒç©º
- `resource-exhausted`: APIä½¿ç”¨é‡ä¸Šé™
- `internal`: Gemini API ã‚¨ãƒ©ãƒ¼

**å®Ÿè£…ä¾‹:**
```typescript
import { httpsCallable } from 'firebase/functions';

const createCompany = httpsCallable(functions, 'createCompany');
const result = await createCompany({ 
  companyName: 'æ ªå¼ä¼šç¤¾ã‚³ãƒ‰ãƒ¢ãƒ³' 
});

if (result.data.success) {
  console.log('ä¼æ¥­ID:', result.data.companyId);
} else if (result.data.isDuplicate) {
  // é‡è¤‡ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
}
```

---

#### ğŸ“Œ POST /reanalyzeCompany

**èª¬æ˜:** ä¼æ¥­æƒ…å ±ã‚’æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã§å†åˆ†æ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  companyId: string;        // å¿…é ˆ: ä¼æ¥­ID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  analysis: {
    businessOverview: string;
    strengths: string[];
    recentNews: string;
    industryPosition: string;
    recruitmentInsights: string;
  };
  analyzedAt: string;       // ISO 8601å½¢å¼
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `not-found`: ä¼æ¥­IDãŒå­˜åœ¨ã—ãªã„
- `resource-exhausted`: 1æ—¥10å›ã®ä¸Šé™åˆ°é”
- `internal`: Gemini API ã‚¨ãƒ©ãƒ¼

**å®Ÿè£…ä¾‹:**
```typescript
const reanalyzeCompany = httpsCallable(functions, 'reanalyzeCompany');
const result = await reanalyzeCompany({ 
  companyId: 'company_abc123' 
});

console.log('å†åˆ†æå®Œäº†:', result.data.analyzedAt);
```

---

#### ğŸ“Œ POST /deleteCompany

**èª¬æ˜:** ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã¨é–¢é€£äºˆå®šã‚’ä¸€æ‹¬å‰Šé™¤

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  companyId: string;        // å¿…é ˆ: ä¼æ¥­ID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  deletedEventCount: number;  // å‰Šé™¤ã•ã‚ŒãŸäºˆå®šæ•°
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `not-found`: ä¼æ¥­IDãŒå­˜åœ¨ã—ãªã„

**å®Ÿè£…ä¾‹:**
```typescript
const deleteCompany = httpsCallable(functions, 'deleteCompany');
const result = await deleteCompany({ 
  companyId: 'company_abc123' 
});

console.log('å‰Šé™¤ã•ã‚ŒãŸäºˆå®šæ•°:', result.data.deletedEventCount);
```

---

### 4.2 äºˆå®šç®¡ç†API

---

#### ğŸ“Œ POST /createEvent

**èª¬æ˜:** äºˆå®šã‚’ç™»éŒ²ã—ã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åŒæœŸ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  companyName: string;      // å¿…é ˆ: ä¼æ¥­åï¼ˆæ—¢å­˜ or æ–°è¦ï¼‰
  eventType: string;        // å¿…é ˆ: ã‚¤ãƒ™ãƒ³ãƒˆç¨®åˆ¥
  date: string;             // å¿…é ˆ: é–‹å§‹æ—¥æ™‚ï¼ˆISO 8601ï¼‰
  endDate: string;          // å¿…é ˆ: çµ‚äº†æ—¥æ™‚ï¼ˆISO 8601ï¼‰
  location?: string;        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: å ´æ‰€
  memo?: string;            // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ãƒ¡ãƒ¢
  syncToCalendar?: boolean; // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: CalendaråŒæœŸï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: trueï¼‰
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  eventId: string;          // ä½œæˆã•ã‚ŒãŸäºˆå®šID
  companyId: string;        // ä¼æ¥­IDï¼ˆæ–°è¦ä½œæˆ or æ—¢å­˜ï¼‰
  calendarEventId?: string; // Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®EventID
  calendarSyncStatus: 'synced' | 'pending' | 'failed';
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `invalid-argument`: å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä¸è¶³
- `internal`: Calendar API ã‚¨ãƒ©ãƒ¼

**å®Ÿè£…ä¾‹:**
```typescript
const createEvent = httpsCallable(functions, 'createEvent');
const result = await createEvent({
  companyName: 'æ ªå¼ä¼šç¤¾ã‚³ãƒ‰ãƒ¢ãƒ³',
  eventType: 'ä¸€æ¬¡é¢æ¥',
  date: '2025-10-15T13:00:00+09:00',
  endDate: '2025-10-15T14:00:00+09:00',
  location: 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ï¼ˆZoomï¼‰',
  memo: 'æ‹…å½“ï¼šä½è—¤æ§˜',
  syncToCalendar: true
});

console.log('äºˆå®šID:', result.data.eventId);
```

---

#### ğŸ“Œ POST /updateEvent

**èª¬æ˜:** äºˆå®šã‚’æ›´æ–°ã—ã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«ã‚‚åæ˜ 

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  eventId: string;          // å¿…é ˆ: äºˆå®šID
  updates: {                // æ›´æ–°å†…å®¹
    eventType?: string;
    date?: string;
    endDate?: string;
    location?: string;
    memo?: string;
    status?: string;
    result?: string;
    resultMemo?: string;
  };
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  calendarSyncStatus: 'synced' | 'pending' | 'failed';
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `not-found`: äºˆå®šIDãŒå­˜åœ¨ã—ãªã„
- `internal`: Calendar API ã‚¨ãƒ©ãƒ¼

**å®Ÿè£…ä¾‹:**
```typescript
const updateEvent = httpsCallable(functions, 'updateEvent');
await updateEvent({
  eventId: 'event_xyz789',
  updates: {
    status: 'completed',
    result: 'passed',
    resultMemo: 'æŠ€è¡“é¢æ¥é€šéï¼'
  }
});
```

---

#### ğŸ“Œ POST /deleteEvent

**èª¬æ˜:** äºˆå®šã‚’å‰Šé™¤ã—ã€Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰ã‚‚å‰Šé™¤

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  eventId: string;          // å¿…é ˆ: äºˆå®šID
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  companyDeleted: boolean;  // ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚ŒãŸã‹
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `not-found`: äºˆå®šIDãŒå­˜åœ¨ã—ãªã„

**å®Ÿè£…ä¾‹:**
```typescript
const deleteEvent = httpsCallable(functions, 'deleteEvent');
const result = await deleteEvent({ 
  eventId: 'event_xyz789' 
});

if (result.data.companyDeleted) {
  console.log('ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
}
```

---

### 4.3 å‚¾å‘åˆ†æAPI

---

#### ğŸ“Œ POST /analyzeTrends

**èª¬æ˜:** ç™»éŒ²ä¼æ¥­ç¾¤ã‹ã‚‰å¿—æœ›å‚¾å‘ã‚’åˆ†æ

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã—
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  summary: {
    overallTrend: string;   // AIã«ã‚ˆã‚‹å…¨ä½“å‚¾å‘ï¼ˆ200æ–‡å­—ï¼‰
    topIndustries: Array<{
      name: string;
      count: number;
      percentage: number;
    }>;
    commonKeywords: Array<{
      word: string;
      count: number;
    }>;
    recommendedSkills: string[];
  };
  analyzedAt: string;
  companyCount: number;
}
```

**ã‚¨ãƒ©ãƒ¼:**
- `invalid-argument`: ä¼æ¥­æ•°ãŒ3ç¤¾æœªæº€
- `resource-exhausted`: 1æ—¥10å›ã®ä¸Šé™åˆ°é”
- `internal`: Gemini API ã‚¨ãƒ©ãƒ¼

**å®Ÿè£…ä¾‹:**
```typescript
const analyzeTrends = httpsCallable(functions, 'analyzeTrends');

try {
  const result = await analyzeTrends({});
  console.log('å‚¾å‘:', result.data.summary.overallTrend);
  console.log('æ¥­ç•Œåˆ†å¸ƒ:', result.data.summary.topIndustries);
} catch (error: any) {
  if (error.code === 'invalid-argument') {
    alert('åˆ†æã«ã¯3ç¤¾ä»¥ä¸Šã®ä¼æ¥­ç™»éŒ²ãŒå¿…è¦ã§ã™');
  } else if (error.code === 'resource-exhausted') {
    alert('æœ¬æ—¥ã®åˆ†æå›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ');
  }
}
```

---

### 4.4 ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸAPIï¼ˆå†…éƒ¨ç”¨ï¼‰

---

#### ğŸ“Œ POST /syncToCalendar

**èª¬æ˜:** äºˆå®šã‚’Googleã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«åŒæœŸï¼ˆå†…éƒ¨Functionï¼‰

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```typescript
{
  eventId: string;
  eventData: {
    companyName: string;
    eventType: string;
    date: string;
    endDate: string;
    location?: string;
    memo?: string;
  };
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```typescript
{
  success: true;
  calendarEventId: string;
}
```

**æ³¨æ„:** ã“ã®Functionã¯ä»–ã®Functionå†…éƒ¨ã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ç›´æ¥å‘¼ã³å‡ºã™ã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚

---

#### ğŸ“Œ POST /retryCalendarSync

**èª¬æ˜:** ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åŒæœŸå¤±æ•—æ™‚ã®è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ï¼ˆFirestore Triggerï¼‰

**ãƒˆãƒªã‚¬ãƒ¼:** `events/{eventId}` ã® `googleCalendar.syncStatus` ãŒ `'failed'` ã«æ›´æ–°ã•ã‚ŒãŸã¨ã

**å‹•ä½œ:**
1. 5åˆ†å¾Œã€30åˆ†å¾Œã€1æ™‚é–“å¾Œã«è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
2. 3å›å¤±æ•—ã—ãŸã‚‰è«¦ã‚ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ‰‹å‹•å†åŒæœŸã‚’ä¿ƒã™

---

## 5. ãƒ¬ãƒ¼ãƒˆåˆ¶é™

### 5.1 åˆ¶é™å€¤

| API | åˆ¶é™ | æœŸé–“ | åˆ¶é™è¶…éæ™‚ |
|-----|------|------|-----------|
| createCompany | ãªã— | - | - |
| reanalyzeCompany | 10å› | 1æ—¥ | `resource-exhausted` |
| analyzeTrends | 10å› | 1æ—¥ | `resource-exhausted` |
| createEvent | ãªã— | - | - |
| updateEvent | ãªã— | - | - |
| deleteEvent | ãªã— | - | - |

### 5.2 å®Ÿè£…æ–¹æ³•

```typescript
// utils/checkUsageLimit.ts
export async function checkUsageLimit(
  userId: string,
  type: 'reAnalysis' | 'trendAnalysis',
  limit: number = 10
): Promise<void> {
  const today = new Date().toISOString().split('T')[0];
  const usageRef = db.doc(`users/${userId}/usage/today`);
  const usageDoc = await usageRef.get();
  
  if (!usageDoc.exists) {
    return; // åˆå›å®Ÿè¡Œ
  }
  
  const data = usageDoc.data();
  if (data.date !== today) {
    return; // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
  }
  
  const count = data.counts?.[type] || 0;
  if (count >= limit) {
    throw new functions.https.HttpsError(
      'resource-exhausted',
      `æœ¬æ—¥ã®${type === 'trendAnalysis' ? 'å‚¾å‘åˆ†æ' : 'å†åˆ†æ'}å›æ•°ä¸Šé™ã«é”ã—ã¾ã—ãŸ`
    );
  }
}
```

---

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 6.1 ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š

```typescript
// functions/src/index.ts
export const createCompany = functions
  .runWith({
    timeoutSeconds: 60,    // æœ€å¤§60ç§’
    memory: '512MB'        // ãƒ¡ãƒ¢ãƒª512MB
  })
  .https.onCall(async (data, context) => {
    // ...
  });
```

### 6.2 ä¸¦åˆ—å‡¦ç†

```typescript
// è¤‡æ•°ã®APIå‘¼ã³å‡ºã—ã‚’ä¸¦åˆ—åŒ–
const [companyData, calendarResult] = await Promise.all([
  createCompanyInFirestore(data),
  syncToGoogleCalendar(data)
]);
```

### 6.3 ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯

```typescript
// utils/retry.ts
export async function retryWithBackoff<T>(
  fn: () => Promise<T>,
  maxRetries: number = 3
): Promise<T> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error: any) {
      if (i === maxRetries - 1) throw error;
      
      // Exponential Backoff
      const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
      await new Promise(resolve => setTimeout(resolve, delay));
    }
  }
  throw new Error('Max retries exceeded');
}
```

---

## 7. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¨ãƒ­ã‚®ãƒ³ã‚°

### 7.1 ãƒ­ã‚°å‡ºåŠ›æ¨™æº–

```typescript
import * as functions from 'firebase-functions';

export const createCompany = functions.https.onCall(async (data, context) => {
  const startTime = Date.now();
  const userId = context.auth?.uid;
  
  // é–‹å§‹ãƒ­ã‚°
  functions.logger.info('createCompany started', {
    userId,
    companyName: data.companyName
  });

  try {
    // å‡¦ç†...
    
    // æˆåŠŸãƒ­ã‚°
    functions.logger.info('createCompany succeeded', {
      userId,
      duration: Date.now() - startTime,
      companyId: result.companyId
    });
    
    return result;
    
  } catch (error: any) {
    // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
    functions.logger.error('createCompany failed', {
      userId,
      error: error.message,
      stack: error.stack,
      duration: Date.now() - startTime
    });
    
    throw error;
  }
});
```

### 7.2 ç›£è¦–ãƒ¡ãƒˆãƒªã‚¯ã‚¹

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | å–å¾—æ–¹æ³• | ã‚¢ãƒ©ãƒ¼ãƒˆæ¡ä»¶ |
|----------|---------|------------|
| å®Ÿè¡Œå›æ•° | Cloud Functions logs | > 1000/æ—¥ |
| å¹³å‡å®Ÿè¡Œæ™‚é–“ | Cloud Functions logs | > 10ç§’ |
| ã‚¨ãƒ©ãƒ¼ç‡ | Cloud Functions logs | > 5% |
| ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›æ•° | Cloud Functions logs | > 10/æ—¥ |

---

## 8. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 8.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
// functions/src/__tests__/createCompany.test.ts
import { createCompany } from '../handlers/companies/createCompany';

describe('createCompany', () => {
  it('ä¼æ¥­ã‚’æ­£å¸¸ã«ç™»éŒ²ã§ãã‚‹', async () => {
    const data = { companyName: 'æ ªå¼ä¼šç¤¾ãƒ†ã‚¹ãƒˆ' };
    const context = { auth: { uid: 'test_user_id' } };
    
    const result = await createCompany(data, context);
    
    expect(result.success).toBe(true);
    expect(result.companyId).toBeDefined();
  });

  it('é‡è¤‡ä¼æ¥­ã‚’æ¤œå‡ºã§ãã‚‹', async () => {
    // 1å›ç›®: æ­£å¸¸ç™»éŒ²
    await createCompany({ companyName: 'æ ªå¼ä¼šç¤¾ãƒ†ã‚¹ãƒˆ' }, context);
    
    // 2å›ç›®: é‡è¤‡æ¤œå‡º
    const result = await createCompany({ companyName: 'ãƒ†ã‚¹ãƒˆ' }, context);
    
    expect(result.isDuplicate).toBe(true);
  });
});
```

### 8.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```typescript
// ã‚¨ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ç’°å¢ƒã§ã®E2Eãƒ†ã‚¹ãƒˆ
describe('äºˆå®šç™»éŒ²ãƒ•ãƒ­ãƒ¼', () => {
  it('ä¼æ¥­ç™»éŒ² â†’ äºˆå®šç™»éŒ² â†’ CalendaråŒæœŸãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹', async () => {
    // 1. ä¼æ¥­ç™»éŒ²
    const companyResult = await createCompany({ 
      companyName: 'æ ªå¼ä¼šç¤¾ãƒ†ã‚¹ãƒˆ' 
    });
    
    // 2. äºˆå®šç™»éŒ²
    const eventResult = await createEvent({
      companyName: 'æ ªå¼ä¼šç¤¾ãƒ†ã‚¹ãƒˆ',
      eventType: 'ä¸€æ¬¡é¢æ¥',
      date: '2025-10-15T13:00:00+09:00',
      endDate: '2025-10-15T14:00:00+09:00'
    });
    
    expect(eventResult.success).toBe(true);
    expect(eventResult.calendarSyncStatus).toBe('synced');
  });
});
```

---

## 9. ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°

### 9.1 APIãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ï¼ˆå°†æ¥ï¼‰

ç¾åœ¨ã¯v1ã®ã¿ã§ã™ãŒã€å°†æ¥çš„ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³åˆ†é›¢:

```typescript
// v1
export const createCompany_v1 = functions.https.onCall(...);

// v2ï¼ˆå°†æ¥ï¼‰
export const createCompany_v2 = functions.https.onCall(...);
```

### 9.2 éæ¨å¥¨ãƒãƒªã‚·ãƒ¼

1. æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒªãƒªãƒ¼ã‚¹
2. æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’3ãƒ¶æœˆé–“ä¸¦è¡Œé‹ç”¨
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ç§»è¡Œé€šçŸ¥
4. æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³å‰Šé™¤

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 10.1 å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

```typescript
function validateCreateCompanyRequest(data: any): void {
  if (!data.companyName || typeof data.companyName !== 'string') {
    throw new functions.https.HttpsError(
      'invalid-argument',
      'ä¼æ¥­åã¯å¿…é ˆã§ã™'
    );
  }
  
  if (data.companyName.length > 100) {
    throw new functions.https.HttpsError(
      'invalid-argument',
      'ä¼æ¥­åã¯100æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„'
    );
  }
}
```

### 10.2 SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯¾ç­–

Firestoreã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã‚¯ã‚¨ãƒªã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€åŸºæœ¬çš„ã«å®‰å…¨ã€‚

```typescript
// å®‰å…¨ãªã‚¯ã‚¨ãƒª
db.collection('companies')
  .where('normalizedName', '==', userInput)  // âœ… å®‰å…¨
  .get();
```

---

## 11. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆ

### 11.1 OpenAPIï¼ˆSwaggerï¼‰ä»•æ§˜ï¼ˆå°†æ¥ï¼‰

Firebase Cloud Functionsã¯ç›´æ¥OpenAPIã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ãŒã€æ‰‹å‹•ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”Ÿæˆå¯èƒ½:

```yaml
openapi: 3.0.0
info:
  title: Job Mete API
  version: 1.5.0
paths:
  /createCompany:
    post:
      summary: ä¼æ¥­ã‚’ç™»éŒ²
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                companyName:
                  type: string
      responses:
        '200':
          description: æˆåŠŸ
```

---

## 12. ã¾ã¨ã‚

æœ¬APIè¨­è¨ˆæ›¸ã¯ã€Job Mete v1.5ã®å…¨ã¦ã®APIä»•æ§˜ã‚’ç¶²ç¾…ã—ã¦ã„ã¾ã™ã€‚

**é‡è¦ãªAPIè¨­è¨ˆåˆ¤æ–­:**
1. **HTTPS Callable:** å‹å®‰å…¨æ€§ã¨è‡ªå‹•èªè¨¼
2. **ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰æ¨™æº–åŒ–:** ä¸€è²«ã—ãŸã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™:** APIä½¿ç”¨é‡ã®é©åˆ‡ãªç®¡ç†
4. **ãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯:** å¤–éƒ¨APIéšœå®³ã¸ã®å¯¾å¿œ
5. **è©³ç´°ãªãƒ­ã‚°:** ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®¹æ˜“åŒ–

ã“ã®APIè¨­è¨ˆã«ã‚ˆã‚Šã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¨ã‚µãƒ¼ãƒãƒ¼é–“ã®é€šä¿¡ãŒå®‰å…¨ã‹ã¤åŠ¹ç‡çš„ã«è¡Œã‚ã‚Œã¾ã™ã€‚